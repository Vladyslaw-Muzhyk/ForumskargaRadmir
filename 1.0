import os
import sys
import time
import threading
import random
import logging
import contextlib
import traceback
import json
import requests  # pip install requests

from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

# === Google Libraries ===
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow
from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload
from google.auth.transport.requests import Request

# === Selenium & Drivers ===
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager

# === Keyboard Control ===
import keyboard

# â€”â€”â€”â€”â€” Ð’Ð•Ð Ð¡Ð†Ð¯ ÐŸÐ ÐžÐ“Ð ÐÐœÐ˜ â€”â€”â€”â€”â€”
CURRENT_VERSION = "1.0"
UPDATE_URL = "https://raw.githubusercontent.com/Vladyslaw-Muzhyk/ForumskargaRadmir/refs/heads/main/1.0"
DOWNLOAD_URL = "https://t.me/+E03PD14rqZRkYzUy"

# â€”â€”â€”â€”â€” Ð’Ð˜ÐŸÐ ÐÐ’Ð›Ð•ÐÐÐ¯ Ð¨Ð›Ð¯Ð¥Ð†Ð’ Ð”Ð›Ð¯ EXE â€”â€”â€”â€”â€”
def get_app_path():
    """Ð’Ð¸Ð·Ð½Ð°Ñ‡Ð°Ñ” Ð¿Ð°Ð¿ÐºÑƒ Ð·Ð°Ð¿ÑƒÑÐºÑƒ, Ð½ÐµÐ·Ð°Ð»ÐµÐ¶Ð½Ð¾ Ð²Ñ–Ð´ Ñ‚Ð¾Ð³Ð¾, ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ†Ðµ Ñ‡Ð¸ EXE"""
    if getattr(sys, 'frozen', False):
        return os.path.dirname(sys.executable)
    return os.path.dirname(os.path.abspath(__file__))

BASE_DIR = get_app_path()
CLIENT_FILE = os.path.join(BASE_DIR, 'client_secrets.json')
TOKEN_FILE = os.path.join(BASE_DIR, 'token.json')
QUEUE_FILE = os.path.join(BASE_DIR, 'queue.json')

# ÐŸÐ°Ð¿ÐºÐ° Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŽ Selenium (Ð·Ð±ÐµÑ€Ñ–Ð³Ð°Ñ”Ñ‚ÑŒÑÑ Ð¿Ð¾Ñ€ÑƒÑ‡ Ð· Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¾ÑŽ)
CHROME_PROFILE_PATH = os.path.join(BASE_DIR, "SeleniumProfile")

# â€”â€”â€”â€”â€” ÐÐÐ›ÐÐ¨Ð¢Ð£Ð’ÐÐÐÐ¯ â€”â€”â€”â€”â€”
SCOPES = ['https://www.googleapis.com/auth/youtube.upload']
WATCH_FOLDER = r"C:\Users\vladm\Videos\Captures"
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(message)s', datefmt='%H:%M:%S')

# Ð“Ð›ÐžÐ‘ÐÐ›Ð¬ÐÐ† Ð¡Ð¢ÐÐÐ˜
abort_current_task = False
DEFERRED_MODE = False  # Ð ÐµÐ¶Ð¸Ð¼ Ð²Ñ–Ð´ÐºÐ»Ð°Ð´ÐºÐ¸ (F3)
IS_IN_MENU = False     # Ð§Ð¸ Ð¼Ð¸ Ð·Ð°Ñ€Ð°Ð· Ð² Ð¼ÐµÐ½ÑŽ (F4)

# === ÐŸÐ•Ð Ð•Ð’Ð†Ð ÐšÐ ÐžÐÐžÐ’Ð›Ð•ÐÐ¬ ===
def check_for_updates():
    try:
        print("ðŸŒ ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½ÑŒ...")
        response = requests.get(UPDATE_URL, timeout=5)
        if response.status_code == 200:
            latest_version = response.text.strip()
            if latest_version != CURRENT_VERSION:
                print("\n" + "!"*50)
                print(f"ðŸš€ Ð”ÐžÐ¡Ð¢Ð£ÐŸÐÐ ÐÐžÐ’Ð Ð’Ð•Ð Ð¡Ð†Ð¯: {latest_version}")
                print(f"Ð’Ð°ÑˆÐ° Ð²ÐµÑ€ÑÑ–Ñ: {CURRENT_VERSION}")
                print(f"ðŸ‘‰ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚Ð¸: {DOWNLOAD_URL}")
                print("!"*50 + "\n")
                time.sleep(3)
            else:
                print("âœ… Ð£ Ð²Ð°Ñ Ð¾ÑÑ‚Ð°Ð½Ð½Ñ Ð²ÐµÑ€ÑÑ–Ñ.")
    except Exception as e:
        print(f"âš ï¸ ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚Ð¸ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ: {e}")

# === Ð ÐžÐ‘ÐžÐ¢Ð Ð— Ð§Ð•Ð Ð“ÐžÐ® (JSON) ===
def load_queue():
    if not os.path.exists(QUEUE_FILE):
        return []
    try:
        with open(QUEUE_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    except:
        return []

def save_queue(queue_data):
    with open(QUEUE_FILE, 'w', encoding='utf-8') as f:
        json.dump(queue_data, f, indent=4, ensure_ascii=False)

def add_to_queue(video_path, complaint_text, complaint_type):
    queue = load_queue()
    entry = {
        "video_path": video_path,
        "complaint_text": complaint_text,
        "complaint_type": complaint_type,
        "timestamp": time.time(),
        "filename": os.path.basename(video_path)
    }
    queue.append(entry)
    save_queue(queue)
    print(f"ðŸ’¾ Ð¡ÐºÐ°Ñ€Ð³Ñƒ Ð·Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð¾ Ð² Ñ‡ÐµÑ€Ð³Ñƒ! (Ð’ÑÑŒÐ¾Ð³Ð¾ Ð² Ñ‡ÐµÑ€Ð·Ñ–: {len(queue)})")

# === Ð¡Ð›Ð£Ð–Ð‘ÐžÐ’Ð† Ð¤Ð£ÐÐšÐ¦Ð†Ð‡ ===
@contextlib.contextmanager
def suppress_output():
    with open(os.devnull, "w") as fnull:
        old_stdout = sys.stdout
        old_stderr = sys.stderr
        sys.stdout = fnull
        sys.stderr = fnull
        try:
            yield
        finally:
            sys.stdout = old_stdout
            sys.stderr = old_stderr

def get_selenium_driver():
    options = Options()
    options.add_argument("--log-level=3")
    options.add_argument("--disable-logging")
    options.add_experimental_option("excludeSwitches", ["enable-logging", "enable-automation"])
    options.add_argument(f"--user-data-dir={CHROME_PROFILE_PATH}")
    options.add_argument("--profile-directory=SeleniumUser")
    options.add_argument("--no-sandbox")
    options.add_argument("--disable-gpu")
    options.add_experimental_option("detach", True) 
    options.add_experimental_option("useAutomationExtension", False)

    with suppress_output():
        service = Service(ChromeDriverManager().install())
        driver = webdriver.Chrome(service=service, options=options)
    return driver

# === Ð§ÐÐ¡Ð¢Ð˜ÐÐ 1: ÐŸÐ•Ð Ð•Ð’Ð†Ð ÐšÐ Ð’Ð¥ÐžÐ”Ð£ ÐÐ Ð¤ÐžÐ Ð£Ðœ ===
def check_forum_login():
    print("\n" + "="*40)
    print("ðŸ”µ Ð•Ð¢ÐÐŸ 1: ÐŸÐ•Ð Ð•Ð’Ð†Ð ÐšÐ Ð’Ð¥ÐžÐ”Ð£ ÐÐ Ð¤ÐžÐ Ð£Ðœ")
    print("="*40)
    driver = get_selenium_driver()
    driver.get("https://forum.radmir.games/")
    print("\nðŸ“¢ Ð‘Ð ÐÐ£Ð—Ð•Ð  Ð’Ð†Ð”ÐšÐ Ð˜Ð¢Ðž! ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ñ–ÑŽ.")
    input("\nâœ… ÐÐ°Ñ‚Ð¸ÑÐ½Ñ–Ñ‚ÑŒ ENTER, ÐºÐ¾Ð»Ð¸ Ð±ÑƒÐ´ÐµÑ‚Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ–...")
    driver.quit()
    print("ðŸŸ¢ ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°.\n")

# === Ð§ÐÐ¡Ð¢Ð˜ÐÐ 2: YOUTUBE ===
def get_service():
    creds = None
    if os.path.exists(TOKEN_FILE):
        creds = Credentials.from_authorized_user_file(TOKEN_FILE, SCOPES)
    
    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            try:
                creds.refresh(Request())
            except Exception:
                if os.path.exists(TOKEN_FILE):
                    os.remove(TOKEN_FILE)
                flow = InstalledAppFlow.from_client_secrets_file(CLIENT_FILE, SCOPES)
                creds = flow.run_local_server(port=0)
        else:
            flow = InstalledAppFlow.from_client_secrets_file(CLIENT_FILE, SCOPES)
            creds = flow.run_local_server(port=0)
        with open(TOKEN_FILE, 'w') as token:
            token.write(creds.to_json())

    return build('youtube', 'v3', credentials=creds)

youtube_service = None 

def wait_for_file_complete(path: str, timeout: int = 60) -> bool:
    start_time = time.time()
    prev_size = -1
    while time.time() - start_time < timeout:
        try:
            curr_size = os.path.getsize(path)
        except FileNotFoundError: return False
        if curr_size == prev_size and curr_size > 0: return True
        prev_size = curr_size
        time.sleep(1)
    return False

# === Ð›ÐžÐ“Ð†ÐšÐ Ð—ÐÐ’ÐÐÐ¢ÐÐ–Ð•ÐÐÐ¯ ===
def upload_to_youtube_api(path, title):
    """Ð§Ð¸ÑÑ‚Ð° Ñ„ÑƒÐ½ÐºÑ†Ñ–Ñ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ, Ð¿Ð¾Ð²ÐµÑ€Ñ‚Ð°Ñ” ID Ð°Ð±Ð¾ ÐºÐ¸Ð´Ð°Ñ” Ð¿Ð¾Ð¼Ð¸Ð»ÐºÑƒ"""
    global youtube_service, abort_current_task
    
    body = {
        'snippet': {'title': title, 'description': 'Auto-upload', 'categoryId': '22'},
        'status': {'privacyStatus': 'public'}
    }
    media = MediaFileUpload(path, chunksize=2 * 1024 * 1024, resumable=True)
    
    request = youtube_service.videos().insert(
        part=','.join(body.keys()), body=body, media_body=media
    )

    max_retries = 5
    retry = 0
    
    while True:
        if abort_current_task: return None # F5
        try:
            status, response = request.next_chunk()
            if status:
                print(f"Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ: {int(status.progress() * 100)}%", end='\r')
            if response:
                print(f"\nâœ” Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð¾! ID: {response['id']}")
                return response['id']
        except Exception as e:
            retry += 1
            if retry > max_retries:
                raise e # ÐšÐ¸Ð´Ð°Ñ”Ð¼Ð¾ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÑƒ Ð´Ð°Ð»Ñ–, Ñ‰Ð¾Ð± Ð²ÐºÐ»ÑŽÑ‡Ð¸Ð²ÑÑ Ñ€ÐµÐ¶Ð¸Ð¼ Ð²Ñ–Ð´ÐºÐ»Ð°Ð´ÐºÐ¸
            time.sleep(random.uniform(2, 2 ** retry))

def process_video_workflow(path):
    """ÐžÑÐ½Ð¾Ð²Ð½Ð¸Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑ: Ð°Ð±Ð¾ Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚ÑŒ, Ð°Ð±Ð¾ Ð·Ð±ÐµÑ€Ñ–Ð³Ð°Ñ” Ð² Ñ‡ÐµÑ€Ð³Ñƒ"""
    global abort_current_task, DEFERRED_MODE
    abort_current_task = False

    filename = os.path.basename(path)
    print("\n" + "âš¡"*40)
    print(f"ðŸŽ¥ Ð—ÐÐÐ™Ð”Ð•ÐÐž: {filename}")
    if DEFERRED_MODE:
        print("ðŸŸ¡ Ð£Ð’Ð†ÐœÐšÐÐ•ÐÐž Ð Ð•Ð–Ð˜Ðœ Ð’Ð†Ð”ÐšÐ›ÐÐ”ÐšÐ˜ (F3)")
    print("âš¡"*40)
    print("ðŸ‘‰ [F1] -> ÐžÐŸÐ ÐÐ¦Ð®Ð’ÐÐ¢Ð˜")
    print("ðŸ‘‰ [F2] -> ÐŸÐ ÐžÐŸÐ£Ð¡Ð¢Ð˜Ð¢Ð˜")
    
    while True:
        if keyboard.is_pressed('f1'):
            print("âœ… ÐŸÑ€Ð¸Ð¹Ð½ÑÑ‚Ð¾...")
            time.sleep(0.5)
            break
        if keyboard.is_pressed('f2'):
            print("âŒ ÐŸÑ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð¾.")
            time.sleep(0.5)
            return
        time.sleep(0.1)

    if not wait_for_file_complete(path):
        return

    # === Ð›ÐžÐ“Ð†ÐšÐ: Ð¯ÐšÐ©Ðž Ð Ð•Ð–Ð˜Ðœ Ð’Ð†Ð”ÐšÐ›ÐÐ”ÐšÐ˜ Ð’ÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð™ ===
    if DEFERRED_MODE:
        print("\nðŸ“ Ð—Ð±Ñ–Ñ€ Ð´Ð°Ð½Ð¸Ñ… Ð´Ð»Ñ Ð²Ñ–Ð´ÐºÐ»Ð°Ð´ÐµÐ½Ð¾Ñ— Ñ‡ÐµÑ€Ð³Ð¸...")
        text, c_type = get_complaint_details(video_link="[LINK_PENDING]")
        if text and c_type:
            add_to_queue(path, text, c_type)
        return

    # === Ð›ÐžÐ“Ð†ÐšÐ: Ð¡Ð¢ÐÐÐ”ÐÐ Ð¢ÐÐ• Ð—ÐÐ’ÐÐÐ¢ÐÐ–Ð•ÐÐÐ¯ ===
    print("ðŸš€ Ð¡Ñ‚Ð°Ñ€Ñ‚ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ... (F5 - Ð’Ñ–Ð´Ð¼Ñ–Ð½Ð°)")
    
    try:
        video_id = upload_to_youtube_api(path, os.path.splitext(filename)[0])
        
        if abort_current_task: 
            print("â›” Ð’Ñ–Ð´Ð¼Ñ–Ð½ÐµÐ½Ð¾ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ÐµÐ¼.")
            return

        if video_id:
            video_link = f"https://www.youtube.com/watch?v={video_id}"
            handle_forum_complaint(video_link)

    except Exception as e:
        print(f"\nâš ï¸ ÐŸÐžÐœÐ˜Ð›ÐšÐ ÐœÐ•Ð Ð•Ð–Ð†/Ð—ÐÐ’ÐÐÐ¢ÐÐ–Ð•ÐÐÐ¯: {e}")
        print("ðŸ”„ ÐÐ’Ð¢ÐžÐœÐÐ¢Ð˜Ð§ÐÐ• ÐŸÐ•Ð Ð•ÐœÐ˜ÐšÐÐÐÐ¯ Ð’ Ð Ð•Ð–Ð˜Ðœ Ð’Ð†Ð”ÐšÐ›ÐÐ”ÐšÐ˜!")
        
        print("ðŸ“ Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ð´Ð°Ð½Ñ– ÑÐºÐ°Ñ€Ð³Ð¸ Ð·Ð°Ñ€Ð°Ð·, Ð²Ñ–Ð´ÐµÐ¾ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ð¼Ð¾ Ð¿Ñ–Ð·Ð½Ñ–ÑˆÐµ:")
        text, c_type = get_complaint_details(video_link="[LINK_PENDING]")
        if text and c_type:
            add_to_queue(path, text, c_type)

# === Ð†ÐÐ¢Ð•Ð Ð¤Ð•Ð™Ð¡Ð˜ Ð’Ð’ÐžÐ”Ð£ ===
def get_complaint_details(video_link):
    # Ð§Ð¸ÑÑ‚ÐºÐ° Ð±ÑƒÑ„ÐµÑ€Ð° ÐºÐ»Ð°Ð²Ñ–Ð°Ñ‚ÑƒÑ€Ð¸
    while keyboard.is_pressed('f1') or keyboard.is_pressed('f2'): time.sleep(0.1)

    print("-" * 30)
    print("ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ Ñ‚Ð¸Ð¿: 1-Ð‘ÐµÐ· Ñ„Ñ€Ð°ÐºÑ†Ñ–Ñ—, 2-Ð‘Ð°Ð½Ð´Ð° (Ð°Ð±Ð¾ 'cancel')")
    complaint_type = input("Ð’Ð¸Ð±Ñ–Ñ€: ").strip()
    if complaint_type.lower() == 'cancel': return None, None

    username = input("Ð’Ð°Ñˆ Ð½Ñ–Ðº: ").strip()
    player_nick = input("ÐÑ–Ðº Ð¿Ð¾Ñ€ÑƒÑˆÐ½Ð¸ÐºÐ°: ").strip()

    if complaint_type == "1":
        reason = input("Ð¡ÑƒÑ‚ÑŒ: ").strip()
        text = f"""1. Ð’Ð°Ñˆ Ð½Ð¸Ðº: {username}
2. ÐÐ¸Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ°, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð¿Ð¸ÑˆÐµÑ‚Ðµ Ð¶Ð°Ð»Ð¾Ð±Ñƒ: {player_nick}
3. Ð¡ÑƒÑ‚ÑŒ Ð¶Ð°Ð»Ð¾Ð±Ñ‹: {reason}
4. Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ Ð¸Ð³Ñ€Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ + /c 060 (ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð² Ð´ÐµÐ½ÑŒ Ð¿Ð¾Ð´Ð°Ñ‡Ð¸ Ð¶Ð°Ð»Ð¾Ð±Ñ‹): Ð² Ð²Ð¸Ð´ÐµÐ¾
5. ÐŸÑ€Ð¸Ð»Ð°Ð³Ð°ÐµÐ¼Ñ‹Ðµ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ñ‹\\Ð²Ð¸Ð´ÐµÐ¾ (ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾): {video_link}"""
        return text, "1"

    elif complaint_type == "2":
        gang_name = input("Ð‘Ð°Ð½Ð´Ð°: ").strip()
        reason = input("Ð¡ÑƒÑ‚ÑŒ: ").strip()
        text = f"""1. Ð’Ð°Ñˆ Ð½Ð¸Ðº: {username}
2. ÐÐ¸Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ°, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð³Ð¾ Ð¿Ð¸ÑˆÐµÑ‚Ðµ Ð¶Ð°Ð»Ð¾Ð±Ñƒ: {player_nick}
3. ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð±Ð°Ð½Ð´Ñ‹, Ð³Ð´Ðµ ÑÐ¾ÑÑ‚Ð¾Ð¸Ñ‚ Ð½Ð°Ñ€ÑƒÑˆÐ¸Ñ‚ÐµÐ»ÑŒ (ÐµÑÐ»Ð¸ Ð²Ð¸Ð´Ð½Ð¾): {gang_name}
4. Ð¡ÑƒÑ‚ÑŒ Ð¶Ð°Ð»Ð¾Ð±Ñ‹: {reason}
5. Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ Ð¸Ð³Ñ€Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ + /c 060 (ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð² Ð´ÐµÐ½ÑŒ Ð¿Ð¾Ð´Ð°Ñ‡Ð¸ Ð¶Ð°Ð»Ð¾Ð±Ñ‹): Ð² Ð²Ð¸Ð´ÐµÐ¾
6. ÐŸÑ€Ð¸Ð»Ð°Ð³Ð°ÐµÐ¼Ñ‹Ðµ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ñ‹\\Ð²Ð¸Ð´ÐµÐ¾ (ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾): {video_link}"""
        return text, "2"
    
    return None, None

def send_complaint_selenium(complaint_text, complaint_type):
    print("ðŸš€ Ð’Ñ–Ð´ÐºÑ€Ð¸Ð²Ð°ÑŽ Ñ„Ð¾Ñ€ÑƒÐ¼...")
    try:
        driver = get_selenium_driver()
        url = "https://forum.radmir.games/forums/Ð–Ð°Ð»Ð¾Ð±Ñ‹-Ð½Ð°-Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²-Ð½Ðµ-ÑÐ¾ÑÑ‚Ð¾ÑÑ‰Ð¸Ñ…-Ð²Ð¾-Ñ„Ñ€Ð°ÐºÑ†Ð¸ÑÑ….996/create-thread" if complaint_type == "1" else "https://forum.radmir.games/forums/Ð–Ð°Ð»Ð¾Ð±Ñ‹-Ð½Ð°-Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²-ÑÐ¾ÑÑ‚Ð¾ÑÑ‰Ð¸Ñ…-Ð²-Ð±Ð°Ð½Ð´Ð°Ñ….998/create-thread"
        driver.get(url)
        
        try:
            WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.ID, "ctrl_title_thread_create")))
        except:
            print("âš ï¸ Ð¤Ð¾Ñ€Ð¼Ð° Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð°. Ð—Ð°Ð¿Ð¾Ð²Ð½Ñ–Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½Ñƒ.")
            input("Enter...")

        lines = complaint_text.splitlines()
        p_nick = next((l.split(":")[1].strip() for l in lines if "ÐÐ¸Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ°" in l), "Player")
        reason_txt = next((l.split(":")[1].strip() for l in lines if "Ð¡ÑƒÑ‚ÑŒ Ð¶Ð°Ð»Ð¾Ð±Ñ‹" in l), "Jaloba")

        try:
            driver.find_element(By.ID, "ctrl_title_thread_create").send_keys(f"{p_nick} | {reason_txt} |")
            driver.switch_to.frame(driver.find_element(By.TAG_NAME, "iframe"))
            driver.find_element(By.TAG_NAME, "body").send_keys(complaint_text)
            driver.switch_to.default_content()
            print("âœ… Ð—Ð°Ð¿Ð¾Ð²Ð½ÐµÐ½Ð¾!")
            input("ÐÐ°Ñ‚Ð¸ÑÐ½Ñ–Ñ‚ÑŒ Enter, Ñ‰Ð¾Ð± Ð·Ð°ÐºÑ€Ð¸Ñ‚Ð¸...")
        except Exception as e:
            print(f"âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð·Ð°Ð¿Ð¾Ð²Ð½ÐµÐ½Ð½Ñ: {e}")

    except Exception as e:
        print(f"âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Selenium: {e}")
    finally:
        if 'driver' in locals(): driver.quit()

def handle_forum_complaint(video_link):
    text, c_type = get_complaint_details(video_link)
    if text and c_type:
        send_complaint_selenium(text, c_type)

# === ÐœÐ•ÐÐ® F4 (Ð§Ð•Ð Ð“Ð Ð’Ð†Ð”ÐšÐ›ÐÐ”ÐšÐ˜) ===
def open_recovery_menu():
    global IS_IN_MENU, abort_current_task
    IS_IN_MENU = True  # ÐŸÐ°ÑƒÐ·Ð° Ð¼Ð¾Ð½Ñ–Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ñƒ
    print("\n" + "ðŸŸ¥"*30)
    print("   ÐœÐ•ÐÐ® Ð’Ð†Ð”ÐšÐ›ÐÐ”Ð•ÐÐ˜Ð¥ Ð¡ÐšÐÐ Ð“ (F4)")
    print("   (ÐœÐ¾Ð½Ñ–Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð½Ð¾Ð²Ð¸Ñ… Ð²Ñ–Ð´ÐµÐ¾ Ð½Ð° Ð¿Ð°ÑƒÐ·Ñ–)")
    print("ðŸŸ¥"*30)

    while True:
        queue = load_queue()
        if not queue:
            print("\nðŸ“­ Ð§ÐµÑ€Ð³Ð° Ð¿Ð¾Ñ€Ð¾Ð¶Ð½Ñ.")
            print("0. Ð’Ð¸Ð¹Ñ‚Ð¸ Ñ– Ð¿Ñ€Ð¾Ð´Ð¾Ð²Ð¶Ð¸Ñ‚Ð¸ Ð¼Ð¾Ð½Ñ–Ñ‚Ð¾Ñ€Ð¸Ð½Ð³")
        else:
            print(f"\nÐ£ Ñ‡ÐµÑ€Ð·Ñ–: {len(queue)} ÑÐºÐ°Ñ€Ð³.")
            for i, item in enumerate(queue):
                print(f"{i+1}. {item['filename']} (Ð’Ñ–Ð´ {time.ctime(item['timestamp'])})")
            print("0. Ð’Ð¸Ð¹Ñ‚Ð¸")
            print("Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ð½Ð¾Ð¼ÐµÑ€ ÑÐºÐ°Ñ€Ð³Ð¸ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð¾Ð±ÐºÐ¸ (Ð°Ð±Ð¾ 0):")

        try:
            choice = input(">> ").strip()
            if choice == '0':
                break
            
            idx = int(choice) - 1
            if 0 <= idx < len(queue):
                item = queue[idx]
                print(f"\nðŸ”„ ÐžÐ±Ñ€Ð¾Ð±ÐºÐ°: {item['filename']}")
                
                # 1. Ð¡Ð¿Ñ€Ð¾Ð±Ð° Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ
                try:
                    video_id = upload_to_youtube_api(item['video_path'], os.path.splitext(item['filename'])[0])
                    if video_id:
                        # 2. Ð—Ð°Ð¼Ñ–Ð½Ð° Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ð² Ñ‚ÐµÐºÑÑ‚Ñ–
                        real_link = f"https://www.youtube.com/watch?v={video_id}"
                        final_text = item['complaint_text'].replace("[LINK_PENDING]", real_link)
                        
                        # 3. ÐŸÑƒÐ±Ð»Ñ–ÐºÐ°Ñ†Ñ–Ñ
                        send_complaint_selenium(final_text, item['complaint_type'])
                        
                        # 4. Ð’Ð¸Ð´Ð°Ð»ÐµÐ½Ð½Ñ Ð· Ñ‡ÐµÑ€Ð³Ð¸ Ð¿Ñ€Ð¸ ÑƒÑÐ¿Ñ–Ñ…Ñƒ
                        del queue[idx]
                        save_queue(queue)
                        print("âœ… Ð¡ÐºÐ°Ñ€Ð³Ð° ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð¾Ð±Ñ€Ð¾Ð±Ð»ÐµÐ½Ð° Ñ– Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ð° Ð· Ñ‡ÐµÑ€Ð³Ð¸.")
                except Exception as e:
                    print(f"âŒ Ð—Ð½Ð¾Ð²Ñƒ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°: {e}")
                    input("Enter Ð´Ð»Ñ Ð¿Ð¾Ð²ÐµÑ€Ð½ÐµÐ½Ð½Ñ Ð² Ð¼ÐµÐ½ÑŽ...")
            else:
                print("ÐÐµÐ²Ñ–Ñ€Ð½Ð¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€.")
        except ValueError:
            print("Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾.")

    IS_IN_MENU = False
    print("\nâ–¶ï¸ ÐœÐ¾Ð½Ñ–Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð²Ñ–Ð´Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾.")

# === Ð“ÐžÐ›ÐžÐ’ÐÐ˜Ð™ Ð¦Ð˜ÐšÐ› ===
class NewVideoHandler(FileSystemEventHandler):
    def on_created(self, event):
        if event.is_directory: return
        if IS_IN_MENU: return # Ð†Ð³Ð½Ð¾Ñ€ÑƒÑ”Ð¼Ð¾ Ð½Ð¾Ð²Ñ– Ñ„Ð°Ð¹Ð»Ð¸, ÑÐºÑ‰Ð¾ Ð¼Ð¸ Ð² Ð¼ÐµÐ½ÑŽ F4
        
        if event.src_path.lower().endswith(('.mp4', '.mov', '.mkv')):
            threading.Thread(target=process_video_workflow, args=(event.src_path,)).start()

def toggle_deferred_mode():
    global DEFERRED_MODE
    DEFERRED_MODE = not DEFERRED_MODE
    state = "Ð£Ð’Ð†ÐœÐšÐÐ•ÐÐž ðŸŸ¡" if DEFERRED_MODE else "Ð’Ð˜ÐœÐšÐÐ•ÐÐž âšª"
    print(f"\n[F3] Ð Ð•Ð–Ð˜Ðœ Ð’Ð†Ð”ÐšÐ›ÐÐ”ÐšÐ˜: {state}")

def check_hotkeys():
    """ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ” Ð½Ð°Ñ‚Ð¸ÑÐºÐ°Ð½Ð½Ñ F3 Ñ– F4 Ñƒ Ñ„Ð¾Ð½Ñ–"""
    while True:
        if keyboard.is_pressed('f3'):
            toggle_deferred_mode()
            time.sleep(0.5) 
        time.sleep(0.1)

if __name__ == '__main__':
    try:
        # 1. Ð¡Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ
        check_for_updates()

        if not os.path.isdir(WATCH_FOLDER):
            print(f"âŒ ÐŸÐ°Ð¿ÐºÐ° Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð°: {WATCH_FOLDER}")
            input("Enter...")
            exit(1)

        # 2. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð½Ð°ÑÐ²Ð½Ð¾ÑÑ‚Ñ– client_secrets (Ð²Ð°Ð¶Ð»Ð¸Ð²Ð¾ Ð´Ð»Ñ EXE)
        if not os.path.exists(CLIENT_FILE):
             print(f"âŒ Ð¤Ð°Ð¹Ð» {CLIENT_FILE} Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾!")
             print("ÐŸÐ¾ÐºÐ»Ð°Ð´Ñ–Ñ‚ÑŒ client_secrets.json Ð¿Ð¾Ñ€ÑƒÑ‡ Ð· .exe Ñ„Ð°Ð¹Ð»Ð¾Ð¼.")
             input("Enter...")
             exit(1)

        check_forum_login()
        youtube_service = get_service()

        print("\n" + "#"*60)
        print(f"ðŸš€ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ ÐœÐžÐÐ†Ð¢ÐžÐ Ð˜ÐÐ“Ð£ v{CURRENT_VERSION} ÐÐšÐ¢Ð˜Ð’ÐÐ")
        print("-" * 60)
        print(f"ðŸ“‚ ÐŸÐ°Ð¿ÐºÐ°: {WATCH_FOLDER}")
        print("âŒ¨ï¸  ÐšÐ•Ð Ð£Ð’ÐÐÐÐ¯:")
        print("   [F1] - ÐžÐ¿Ñ€Ð°Ñ†ÑŽÐ²Ð°Ñ‚Ð¸ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ðµ Ð²Ñ–Ð´ÐµÐ¾")
        print("   [F2] - ÐŸÑ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ Ð²Ñ–Ð´ÐµÐ¾")
        print("   [F3] - Ð’ÐšÐ›/Ð’Ð˜ÐšÐ› Ð ÐµÐ¶Ð¸Ð¼ Ð²Ñ–Ð´ÐºÐ»Ð°Ð´ÐºÐ¸ (ÑÐºÐ°Ñ€Ð³Ð¸ Ð² Ñ‡ÐµÑ€Ð³Ñƒ Ð±ÐµÐ· Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ)")
        print("   [F4] - Ð’Ñ–Ð´ÐºÑ€Ð¸Ñ‚Ð¸ Ð¼ÐµÐ½ÑŽ Ð’Ð†Ð”ÐšÐ›ÐÐ”Ð•ÐÐ˜Ð¥ Ð¡ÐšÐÐ Ð“ (Ð¿Ð°ÑƒÐ·Ð° Ð¼Ð¾Ð½Ñ–Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ñƒ)")
        print("   [F5] - Ð•ÐºÑÑ‚Ñ€ÐµÐ½Ð° Ð²Ñ–Ð´Ð¼Ñ–Ð½Ð° Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ")
        print("#"*60 + "\n")

        observer = Observer()
        observer.schedule(NewVideoHandler(), WATCH_FOLDER, recursive=False)
        observer.start()
        
        threading.Thread(target=check_hotkeys, daemon=True).start()

        while True:
            # ÐžÑÐ½Ð¾Ð²Ð½Ð¸Ð¹ Ð¿Ð¾Ñ‚Ñ–Ðº ÑÐ»ÑƒÑ…Ð°Ñ” F4
            if keyboard.is_pressed('f4') and not IS_IN_MENU:
                time.sleep(0.3)
                open_recovery_menu()
            time.sleep(0.1)

    except KeyboardInterrupt:
        observer.stop()
        observer.join()
    except Exception as e:
        traceback.print_exc()
        input("Error. Enter...")
